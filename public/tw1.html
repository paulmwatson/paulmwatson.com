<html>
  <head>
    <title>Storyful</title>
    <link href="tw1.css" media="all" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <h1>Live Discussion</h1>
    <form method="get">
      <input type="text" placeholder="Enter a search term" id="q" name="q" /><input type="submit" value="Go" />
    </form>
    <div id="dynaCloudText"></div>
    <div class="popularKeywords">
      <h2>Popular Keywords</h2>
      <div id="dynacloud"></div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script src="/javascripts/jquery.dynacloud-5.js"></script>
    <script src="http://widgets.twimg.com/j/2/widget.js"></script>
    <script type="text/javascript">
      var qs = document.location.search.match(/q=(.*)/)

      $.dynaCloud.max = 10;
      //$.dynaCloud.sort = false;
      $.dynaCloud.auto = false;

      if (qs && qs.length === 2)
      {
        var search_term = unescape(qs[1]);
        $('#q').val(search_term);
        new TWTR.Widget({
          version: 2,
          type: 'search',
          search: search_term,
          interval: 30000,
          title: '',
          subject: '',
          width: 'auto',
          height: 1500,
          theme: {
            shell: {
              background: '#2a2a2a',
              color: '#ffffff'
            },
            tweets: {
              background: '#2a2a2a',
              color: '#ffffff',
              links: '#30B4E2'
            }
          },
          features: {
            scrollbar: false,
            loop: true,
            live: true,
            hashtags: true,
            timestamp: true,
            avatars: true,
            toptweets: false,
            behavior: 'default'
          }
        }).render().start();
        
        function generateTagCloud()
        {
          var search_term_regex = new RegExp(search_term, 'gi');
          $('#dynaCloudText').text($('.twtr-tweet-text').text().replace(/RT /gi, '').replace(search_term_regex, ''))
          $('#dynaCloudText').dynaCloud().find('a').hide().fadeIn();
          setTimeout(generateTagCloud, 1000);
          $('.popularKeywords #dynaCloud a').each(function(i, a){
            var text = $(a).text();
            var style = $(a).attr('style');
            $(a).replaceWith('<span style="' + style + '">' + text + '</span>');
          });

          if ($('.popularKeywords').is(':hidden') && $('.popularKeywords #dynaCloud span').length > 0)
          {
            $('.popularKeywords').slideDown();
          }
        }
        setTimeout(generateTagCloud, 1000);
      }
    </script>
  </body>
</html>